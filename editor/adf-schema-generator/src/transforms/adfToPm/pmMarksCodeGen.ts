import camelCase from 'lodash/camelCase';
import type { ADFAttributes } from '../../types/ADFAttribute';
import type { ADFMarkSpec } from '../../types/ADFMarkSpec';
import {
	_codeBlock,
	_namedImport,
	_namedTypeImport,
	_interface,
	buildADFAttributesTypes,
	_functionCallToVariable,
	_type,
	convertTypeToTypeName,
	stringifyWithUndefined,
} from './codeGenHelpers';
import { adfToPmAutogeneratedMessage } from './adfToPmAutogeneratedMessage';
import type { MarkSpecResMap } from './types';
import { objectToSortedArray } from './objectToSortedArray';

export const _markInterfaces = (
	markName: string,
	markType: string,
	markTypeDefinitionName: string,
	markAttrs: ADFAttributes,
): string => {
	const markAttrsName = `${markName}Attributes`;
	if (markAttrs) {
		return [
			_interface(markAttrsName, buildADFAttributesTypes(markAttrs).join(';')),
			_interface(markTypeDefinitionName, `type: "${markType}", attrs: ${markAttrsName}`),
			_interface(`${markName} extends Mark`, `attrs: ${markAttrsName}`),
		].join('\n\n');
	}
	return [_interface(markTypeDefinitionName, `type: "${markType}"`), _type(markName, 'Mark')].join(
		'\n\n',
	);
};

export function pmMarksCodeGen(markResMap: Record<string, MarkSpecResMap>): string {
	return _codeBlock(
		adfToPmAutogeneratedMessage,
		_namedImport('../../schema/createPMSpecFactory', 'createPMMarkSpecFactory'),
		_namedTypeImport('@atlaskit/editor-prosemirror/model', 'Mark'),
		objectToSortedArray(markResMap)
			.map(([key, { mark, pmMarkSpec }]) => {
				const functionName = camelCase(key);
				const markName = convertTypeToTypeName(key, 'Mark');
				const markTypeDefinitionName = convertTypeToTypeName(key, 'Definition');
				const markAttrs = (mark.getSpec() as ADFMarkSpec).attrs;

				return _codeBlock(
					// build mark types
					_markInterfaces(
						markName,
						mark.getType(),
						markTypeDefinitionName,
						markAttrs as ADFAttributes,
					),
					// build markSpec
					_functionCallToVariable(
						functionName,
						`createPMMarkSpecFactory${markAttrs ? `<${markName}>` : ''}`,
						[stringifyWithUndefined(pmMarkSpec)],
					),
				);
			})
			.join('\n\n'),
	);
}
