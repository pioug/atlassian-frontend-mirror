import { _codeBlock, _type, convertTypeToTypeName, _namedTypeImport } from './codeGenHelpers';
import { adfToPmAutogeneratedMessage } from './adfToPmAutogeneratedMessage';
import { objectToSortedArray } from './objectToSortedArray';

export function pmNodeGroupsCodeGen(nodeGroupMap: Record<string, string[]>): string {
	const uniqueTypeImports = new Set<string>();
	const groupTypesDefinitions = [];

	for (const [key, value] of objectToSortedArray(nodeGroupMap)) {
		if (value.length === 0) {
			continue;
		}

		const uniqNodeGroups = [...new Set(value)];
		const childTypes: Array<string> = [];

		for (const group of uniqNodeGroups) {
			const typeName = convertTypeToTypeName(group);
			childTypes.push(typeName);
			uniqueTypeImports.add(typeName);
		}

		const typeName = convertTypeToTypeName(key);
		groupTypesDefinitions.push(_type(typeName, `Array<${childTypes.join('|')}>`));
	}

	const typeImportsArray: Array<string> = Array.from(uniqueTypeImports);
	typeImportsArray.sort();

	return _codeBlock(
		adfToPmAutogeneratedMessage,
		_namedTypeImport('./nodeTypes', ...typeImportsArray),
		groupTypesDefinitions.join('\n\n'),
	);
}
